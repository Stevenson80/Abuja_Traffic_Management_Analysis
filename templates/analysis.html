<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abuja Traffic Congestion Analysis - Comprehensive Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Data passed from Flask backend -->
    <script id="summaryData" type="application/json">{{ summary | tojson }}</script>
    <script id="roadResultsData" type="application/json">{{ road_results | tojson }}</script>
    <script id="vehicleDistributionsData" type="application/json">{{ vehicle_distributions | tojson }}</script>
    <script id="emissionModelData" type="application/json">{{ current_emission_model | tojson }}</script>

    <style>
        :root {
            --primary-color: #1a2a6c;
            --secondary-color: #b21f1f;
            --accent-color: #fdbb2d;
            --light-color: #f0f7ff;
            --dark-color: #2c3e50;
            --border-color: #dee2e6;
            --success-color: #d4edda;
            --error-color: #f8d7da;
            --warning-color: #fff3cd;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e6e9f0 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .navbar {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            text-align: center;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .navbar a {
            padding: 12px 24px;
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 500;
            background-color: var(--light-color);
            border-radius: 50px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            border: 2px solid transparent;
            font-family: 'Poppins', sans-serif;
        }

        .navbar a:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .navbar a.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .navbar a i {
            margin-right: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }

        h1 {
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: 700;
        }

        h2 {
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            margin-top: 30px;
            font-weight: 600;
        }

        h3 {
            color: var(--secondary-color);
            margin-top: 25px;
            font-weight: 500;
        }

        h4 {
            color: var(--primary-color);
            margin-top: 20px;
            padding-left: 10px;
            border-left: 4px solid var(--accent-color);
            font-weight: 500;
        }

        .flash-message {
            margin-bottom: 25px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .flash-message.success {
            background-color: var(--success-color);
            color: #155724;
            border-color: #c3e6cb;
        }

        .flash-message.error {
            background-color: var(--error-color);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .flash-message.info {
            background-color: var(--warning-color);
            color: #856404;
            border-color: #ffeeba;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--light-color) 0%, #e9ecef 100%);
            padding: 25px 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,08);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }

        .summary-card h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.1em;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            font-family: 'Poppins', sans-serif;
        }

        .summary-card .unit {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 14px 16px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-family: 'Poppins', sans-serif;
        }

        tr:nth-child(even) {
            background-color: var(--light-color);
        }

        tr:hover {
            background-color: #e9ecef;
            transition: background-color 0.2s ease;
        }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin: 30px 0;
        }

        .chart-box {
            flex: 1 1 450px;
            min-width: 320px;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .chart-box:hover {
            transform: translateY(-3px);
        }

        .chart-box h4 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .download-btn {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            justify-content: center;
        }

        .download-btn a {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--accent-color), #e65c00);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(253, 187, 45, 0.4);
            font-family: 'Poppins', sans-serif;
        }

        .download-btn a:hover {
            background: linear-gradient(135deg, #e65c00, var(--accent-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253, 187, 45, 0.5);
        }

        .methodology {
            background: #e8f4fc;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border-left: 4px solid var(--primary-color);
        }

        .recommendations {
            background: #f0f7ff;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border-left: 4px solid var(--accent-color);
        }

        .recommendations ul {
            padding-left: 25px;
            margin: 18px 0;
        }

        .recommendations li {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #6c757d;
            font-size: 14px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .data-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            font-size: 0.95em;
            border-left: 4px solid var(--secondary-color);
        }

        .road-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .road-card {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--secondary-color);
        }

        .road-card:hover {
            transform: translateY(-3px);
        }

        .road-card h4 {
            color: var(--secondary-color);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--secondary-color);
            font-weight: 600;
        }

        /* Model selection styles */
        .model-selection {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            border: 2px solid var(--secondary-color);
        }

        .model-selection h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .model-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .model-select {
            flex: 1;
            min-width: 200px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            background-color: white;
            font-family: 'Roboto', sans-serif;
        }

        .model-submit {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }

        .model-submit:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .model-info-box {
            margin-top: 20px;
            padding: 20px;
            background: #e8f4fc;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary-color);
        }

        .model-info-box p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .model-badge {
            display: inline-block;
            padding: 6px 14px;
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            font-family: 'Poppins', sans-serif;
        }

        /* Advanced parameters section */
        .advanced-params {
            background: #fff3cd;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border-left: 4px solid #ffc107;
        }

        .advanced-params h4 {
            color: #856404;
            margin-top: 0;
            border-left: 4px solid #ffc107;
            font-weight: 600;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-top: 18px;
        }

        .param-item {
            background: white;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .param-item strong {
            color: #856404;
            display: block;
            margin-bottom: 8px;
            font-family: 'Poppins', sans-serif;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .navbar {
                flex-direction: column;
                align-items: center;
            }

            .navbar a {
                width: 100%;
                max-width: 300px;
                justify-content: center;
                margin: 5px 0;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                flex-direction: column;
            }

            .chart-box {
                flex: 1 1 100%;
            }

            .download-btn {
                flex-direction: column;
                align-items: center;
            }

            .download-btn a {
                width: 100%;
                justify-content: center;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px;
            }

            .model-form {
                flex-direction: column;
                align-items: stretch;
            }

            .model-select {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .summary-card {
                padding: 20px 15px;
            }

            .summary-card .value {
                font-size: 1.6em;
            }
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .scrollable-table {
            overflow-x: auto;
            margin: 25px 0;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Loading indicator for charts */
        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
        }

        .chart-loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Simple chart styles */
        .simple-bar-chart {
            margin-top: 15px;
        }

        .chart-bar {
            margin: 12px 0;
        }

        .chart-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .chart-bar-container {
            background: #e9ecef;
            height: 22px;
            border-radius: 4px;
            overflow: hidden;
        }

        .chart-bar-fill {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            height: 100%;
            transition: width 1s ease-in-out;
        }

        .simple-pie-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #1a2a6c 0% 30%,
                #b21f1f 30% 60%,
                #fdbb2d 60% 80%,
                #1c6b3d 80% 95%,
                #6b2c90 95% 100%
            );
        }

        .pie-legend {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .pie-legend-color {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            border-radius: 3px;
        }

        .data-highlight {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            text-align: center;
        }

        .data-highlight .value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            font-family: 'Poppins', sans-serif;
        }

        .data-highlight .label {
            font-size: 1.1em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="navbar" role="navigation" aria-label="Main navigation">
        <a href="{{ url_for('welcome') }}" aria-label="Home page"><i class="fas fa-home"></i> Home</a>
        <a href="{{ url_for('analysis') }}" aria-label="Analysis page" class="active"><i class="fas fa-chart-bar"></i> Analysis</a>
        <a href="{{ url_for('data_entry') }}" aria-label="Data entry page"><i class="fas fa-pen-to-square"></i> Data Entry</a>
        <a href="{{ url_for('download_report') }}" aria-label="Download CSV report"><i class="fas fa-file-csv"></i> CSV Report</a>
        <a href="{{ url_for('download_pdf') }}" aria-label="Download PDF report"><i class="fas fa-file-pdf"></i> PDF Report</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-message {{ messages[0][0] }}" role="alert">
                <i class="fas fa-{% if messages[0][0] == 'success' %}check-circle{% elif messages[0][0] == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                <div>
                    {% for category, message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <div class="container">
        <h1><i class="fas fa-traffic-light"></i> Comprehensive Traffic Congestion Analysis</h1>
        <p class="text-center" style="color: #6c757d; margin-bottom: 30px;">Abuja Roads: Nyanya, Lugbe, and Kubwa Corridors</p>

        <!-- Emission Model Selection -->
        <div class="model-selection">
            <h3><i class="fas fa-calculator"></i> Emission Model Selection</h3>
            <form method="get" action="{{ url_for('analysis') }}" class="model-form">
                <select name="emission_model" class="model-select" onchange="this.form.submit()">
                    {% for model in emission_models %}
                    <option value="{{ model }}" {% if current_emission_model == model %}selected{% endif %}>
                        {{ model|upper }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="model-submit">
                    <i class="fas fa-sync-alt"></i> Apply Model
                </button>
            </form>

            <div class="model-info-box">
                <p>
                    <span class="model-badge">{{ current_emission_model|upper }}</span>
                    {% if current_emission_model == 'basic' %}
                    Using simple fuel consumption-based emission calculations with fixed emission factors.
                    {% elif current_emission_model == 'barth' %}
                    Using Barth's comprehensive fuel consumption model with acceleration, deceleration, and idle time factors.
                    {% elif current_emission_model == 'moves' %}
                    Using EPA MOVES-like emission model with speed, acceleration, and vehicle standard corrections.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Advanced Parameters Display -->
        {% if current_emission_model != 'basic' %}
        <div class="advanced-params">
            <h4><i class="fas fa-cogs"></i> Advanced Calculation Parameters</h4>
            <div class="param-grid">
                <div class="param-item">
                    <strong>Free Flow Speed</strong>
                    <span id="freeFlowSpeed">{{ summary.get('Free_Flow_Speed_KPH', 60.0) }}</span> km/h
                </div>
                <div class="param-item">
                    <strong>Congested Speed</strong>
                    <span id="congestedSpeed">{{ summary.get('Congested_Speed_KPH', 8.0) }}</span> km/h
                </div>
                <div class="param-item">
                    <strong>Acceleration</strong>
                    <span id="acceleration">{{ summary.get('Avg_Acceleration', 0.5) }}</span> m/s²
                </div>
                <div class="param-item">
                    <strong>Deceleration</strong>
                    <span id="deceleration">{{ summary.get('Avg_Deceleration', 0.5) }}</span> m/s²
                </div>
                <div class="param-item">
                    <strong>Idle Time</strong>
                    <span id="idleTime">{{ (summary.get('Idle_Time_Percentage', 0.3) * 100) }}</span>%
                </div>
            </div>
        </div>
        {% endif %}

        <div class="data-info">
            <p><strong><i class="fas fa-calendar-alt"></i> Analysis Date:</strong> <span id="analysisDate"></span></p>
            <p><strong><i class="fas fa-clock"></i> Analysis Time:</strong> <span id="analysisTime"></span></p>
            <p><strong><i class="fas fa-calculator"></i> Emission Model:</strong> {{ current_emission_model|upper }}</p>
            <p><strong><i class="fas fa-info-circle"></i> Note:</strong> Data represents current traffic conditions analysis.</p>
        </div>

        <h2><i class="fas fa-chart-line"></i> Executive Summary</h2>

        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Vehicles</h3>
                <div class="value" id="totalVehicles">0</div>
                <div class="unit">across all corridors</div>
            </div>
            <div class="summary-card">
                <h3>People Affected</h3>
                <div class="value" id="totalPeople">0</div>
                <div class="unit">commuters impacted</div>
            </div>
            <div class="summary-card">
                <h3>Total Delay</h3>
                <div class="value" id="totalDelay">0 hours</div>
                <div class="unit">hours lost</div>
            </div>
            <div class="summary-card">
                <h3>Economic Impact</h3>
                <div class="value" id="totalEconomicImpact">₦0</div>
                <div class="unit">fuel + productivity loss</div>
            </div>
        </div>

        <div class="data-highlight">
            <div class="label">Total Environmental Impact</div>
            <div class="value" id="totalCO2">0 kg CO₂</div>
            <div class="label">Equivalent to <span id="treeEquivalent">0</span> average trees' annual absorption</div>
        </div>

        <h2><i class="fas fa-calculator"></i> Methodology</h2>
        <div class="methodology">
            <p>This analysis uses vehicle-specific occupancy rates and fuel consumption parameters with the following key assumptions:</p>
            <ul>
                <li><strong>Fuel Prices (2026):</strong> ₦1,045.0/L (petrol), ₦1,210.0/L (diesel)</li>
                <li><strong>Emission Factors:</strong> 2.31 kg CO₂/L (petrol), 2.68 kg CO₂/L (diesel)</li>
                <li><strong>Productivity Value:</strong> ₦8.80/minute based on economic calculations</li>
                <li><strong>Corridor Length:</strong> 6.0 km average distance</li>
                <li><strong>Time Parameters:</strong> Free flow: 4.0 min, Congested: 45.0 min</li>
                {% if current_emission_model != 'basic' %}
                <li><strong>Advanced Parameters:</strong>
                    Free flow speed: <span id="methodologyFreeFlowSpeed">{{ summary.get('Free_Flow_Speed_KPH', 60.0) }}</span> km/h,
                    Congested speed: <span id="methodologyCongestedSpeed">{{ summary.get('Congested_Speed_KPH', 8.0) }}</span> km/h,
                    Acceleration: <span id="methodologyAcceleration">{{ summary.get('Avg_Acceleration', 0.5) }}</span> m/s²,
                    Idle time: <span id="methodologyIdleTime">{{ (summary.get('Idle_Time_Percentage', 0.3) * 100) }}</span>%
                </li>
                {% endif %}
                <li><strong>Emission Model:</strong> {{ current_emission_model|upper }}</li>
            </ul>
        </div>

        <h2><i class="fas fa-chart-bar"></i> Grand Totals Across All Roads</h2>
        <div class="scrollable-table">
            <table role="grid" aria-label="Summary of traffic metrics across all roads">
                <thead>
                    <tr>
                        <th>Performance Metric</th>
                        <th>Value</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody id="grandTotalsBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <h2><i class="fas fa-road"></i> Per-Road Analysis</h2>
        <div class="road-comparison" id="roadComparison">
            <!-- Will be populated by JavaScript -->
        </div>

        <h2><i class="fas fa-chart-pie"></i> Vehicle Distribution Analysis</h2>
        <p>The pie charts below illustrate the distribution of vehicle types across each road corridor:</p>

        <div class="chart-container" id="vehicleDistributionCharts">
            <!-- Will be populated by JavaScript -->
        </div>

        <h2><i class="fas fa-chart-bar"></i> Comparative Analysis</h2>
        <p>The following charts compare key metrics across the road corridors:</p>

        <div class="chart-container" id="comparativeCharts">
            <div class="chart-box">
                <h4>People Affected by Congestion</h4>
                <div class="chart-loading" id="peopleChart">
                    <div class="spinner"></div>
                    <p>Loading chart...</p>
                </div>
            </div>
            <div class="chart-box">
                <h4>Excess Fuel Consumption (Liters)</h4>
                <div class="chart-loading" id="fuelChart">
                    <div class="spinner"></div>
                    <p>Loading chart...</p>
                </div>
            </div>
            <div class="chart-box">
                <h4>CO2 Emissions (kg)</h4>
                <div class="chart-loading" id="co2Chart">
                    <div class="spinner"></div>
                    <p>Loading chart...</p>
                </div>
            </div>
            <div class="chart-box">
                <h4>Total Cost (Fuel + Productivity Loss)</h4>
                <div class="chart-loading" id="costChart">
                    <div class="spinner"></div>
                    <p>Loading chart...</p>
                </div>
            </div>
        </div>

        <h2><i class="fas fa-file-alt"></i> Detailed Report Data</h2>
        <div class="scrollable-table">
            <table role="grid" aria-label="Detailed traffic congestion report">
                <thead>
                    <tr>
                        <th>Road</th>
                        <th>Vehicle Type</th>
                        <th>Count</th>
                        <th>People</th>
                        <th>Delay (min)</th>
                        <th>Excess Fuel (L)</th>
                        <th>Fuel Cost (₦)</th>
                        <th>CO2 (kg)</th>
                        <th>Productivity Loss (₦)</th>
                        <th>Emission Model</th>
                    </tr>
                </thead>
                <tbody id="reportDataBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <h2><i class="fas fa-lightbulb"></i> Recommendations</h2>
        <div class="recommendations">
            <p>Based on the traffic congestion analysis, the following interventions are recommended:</p>
            <ul>
                <li><strong>Traffic Management:</strong> Implement intelligent traffic management systems to reduce congestion during peak hours</li>
                <li><strong>Public Transportation:</strong> Enhance alternative transportation options to reduce private vehicle numbers</li>
                <li><strong>Infrastructure Investment:</strong> Prioritize road improvements based on specific congestion patterns</li>
                <li><strong>Carpooling Promotion:</strong> Encourage ridesharing to increase vehicle occupancy rates</li>
                <li><strong>Congestion Pricing:</strong> Consider implementing congestion pricing during peak hours</li>
                <li><strong>Environmental Mitigation:</strong> Develop strategies to offset CO2 emissions from traffic congestion</li>
                <li><strong>Model Selection:</strong> Continue using {{ current_emission_model|upper }} model for future analyses to maintain consistency in emission calculations</li>
            </ul>
        </div>

        <div class="download-btn">
            <a href="{{ url_for('download_report') }}?emission_model={{ current_emission_model }}" aria-label="Download CSV report"><i class="fas fa-file-csv"></i> Download CSV Report</a>
            <a href="{{ url_for('download_pdf') }}?emission_model={{ current_emission_model }}" aria-label="Download PDF report"><i class="fas fa-file-pdf"></i> Download PDF Report</a>
            <a href="{{ url_for('download_traffic_data') }}" aria-label="Download input data as CSV"><i class="fas fa-download"></i> Download Input Data</a>
            <a href="{{ url_for('data_entry') }}" aria-label="Enter new traffic data"><i class="fas fa-pen-to-square"></i> Enter New Data</a>
        </div>
    </div>

    <footer>
        <p>© <span id="currentYear"></span> | Powered by Opygoal Technology Ltd | Developed by Oladotun Ajakaiye | Service Manager & Data Analyst</p>
        <p>Abuja Traffic Analysis System v2.0 | {{ current_emission_model|upper }} Emission Model</p>
    </footer>

    <script>
        // Parse data from Flask backend
        const summaryData = JSON.parse(document.getElementById('summaryData').textContent || '{}');
        const roadResultsData = JSON.parse(document.getElementById('roadResultsData').textContent || '{}');
        const vehicleDistributionsData = JSON.parse(document.getElementById('vehicleDistributionsData').textContent || '{}');
        const emissionModel = JSON.parse(document.getElementById('emissionModelData').textContent || '"basic"');

        // Define vehicle classes for consistency
        const VEHICLE_CLASSES = {
            'car': 'Cars',
            'bus': 'Buses',
            'truck': 'Trucks',
            'motorcycle': 'Motorcycles',
            'suv': 'SUVs'
        };

        // Mapping old vehicle types to new ones (adjust based on actual old vehicle types)
        const VEHICLE_TYPE_MAPPING = {
            'saloon_car': 'car',
            'taxi': 'car',
            'mini_bus': 'bus',
            'large_bus': 'bus',
            'light_truck': 'truck',
            'heavy_truck': 'truck',
            'motorcycle': 'motorcycle',
            'suv': 'suv'
        };

        // Preprocess roadResultsData to map old vehicle types to new ones
        function preprocessVehicleData(data) {
            const processedData = {};
            for (const [roadName, roadData] of Object.entries(data)) {
                if (roadData.vehicle_types) {
                    const newVehicleTypes = {};
                    for (const [oldType, vehicleData] of Object.entries(roadData.vehicle_types)) {
                        const newType = VEHICLE_TYPE_MAPPING[oldType] || 'car'; // Default to 'car' if unknown
                        if (!newVehicleTypes[newType]) {
                            newVehicleTypes[newType] = {
                                count: 0,
                                people: 0,
                                delay_min: 0,
                                excess_fuel_l: 0,
                                fuel_cost_naira: 0,
                                co2_kg: 0,
                                productivity_loss_naira: 0
                            };
                        }
                        newVehicleTypes[newType].count += vehicleData.count || 0;
                        newVehicleTypes[newType].people += vehicleData.people || 0;
                        newVehicleTypes[newType].delay_min += vehicleData.delay_min || 0;
                        newVehicleTypes[newType].excess_fuel_l += vehicleData.excess_fuel_l || 0;
                        newVehicleTypes[newType].fuel_cost_naira += vehicleData.fuel_cost_naira || 0;
                        newVehicleTypes[newType].co2_kg += vehicleData.co2_kg || 0;
                        newVehicleTypes[newType].productivity_loss_naira += vehicleData.productivity_loss_naira || 0;
                    }
                    processedData[roadName] = { ...roadData, vehicle_types: newVehicleTypes };
                } else {
                    processedData[roadName] = roadData;
                }
            }
            return processedData;
        }

        // Preprocess vehicleDistributionsData to map old vehicle types to new ones
        function preprocessVehicleDistributions(data) {
            const processedData = {};
            for (const [roadName, vehicles] of Object.entries(data)) {
                const newVehicles = [];
                const vehicleCounts = {};
                Object.keys(VEHICLE_CLASSES).forEach(vt => vehicleCounts[vt] = 0);

                vehicles.forEach(v => {
                    const newType = VEHICLE_TYPE_MAPPING[v.vehicle_type] || 'car';
                    vehicleCounts[newType] += v.count || 0;
                });

                Object.entries(vehicleCounts).forEach(([vehicleType, count]) => {
                    if (count > 0) {
                        newVehicles.push({ vehicle_type: VEHICLE_CLASSES[vehicleType], count });
                    }
                });

                processedData[roadName] = newVehicles;
            }
            return processedData;
        }

        // Apply preprocessing
        const processedRoadResultsData = preprocessVehicleData(roadResultsData);
        const processedVehicleDistributionsData = preprocessVehicleDistributions(vehicleDistributionsData);

        // Set current date and year
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        document.getElementById('analysisDate').textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        });
        document.getElementById('analysisTime').textContent = new Date().toLocaleTimeString('en-US', {
            hour: '2-digit', minute: '2-digit'
        });

        // Format number with commas
        function formatNumber(number) {
            return new Intl.NumberFormat('en-US').format(number);
        }

        // Format currency
        function formatCurrency(amount) {
            return '₦' + formatNumber(amount.toFixed(2));
        }

        // Format float with 1 decimal
        function formatFloat(number, decimals = 1) {
            return parseFloat(number).toFixed(decimals);
        }

        // Create a simple bar chart
        function createSimpleBarChart(data, title, containerId, formatter = formatNumber) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const maxValue = Math.max(...Object.values(data));
            let chartHTML = `<div class="simple-bar-chart">`;

            for (const [label, value] of Object.entries(data)) {
                const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                chartHTML += `
                    <div class="chart-bar">
                        <div class="chart-label">
                            <span>${label}</span>
                            <span>${formatter(value)}</span>
                        </div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }

            chartHTML += `</div>`;
            container.innerHTML = chartHTML;

            // Animate the bars
            setTimeout(() => {
                const bars = container.querySelectorAll('.chart-bar-fill');
                bars.forEach(bar => {
                    bar.style.width = bar.style.width;
                });
            }, 100);
        }

        // Create a simple pie chart for vehicle distribution
        function createSimplePieChart(data, title, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Generate conic gradient string
            let cumulativePercentage = 0;
            let gradientString = '';
            const colors = ['#1a2a6c', '#b21f1f', '#fdbb2d', '#1c6b3d', '#6b2c90'];

            data.forEach((item, index) => {
                const percentage = (item.count / data.reduce((sum, curr) => sum + curr.count, 0)) * 100;
                const start = cumulativePercentage;
                const end = cumulativePercentage + percentage;

                gradientString += `${colors[index % colors.length]} ${start}% ${end}%, `;
                cumulativePercentage = end;
            });

            // Remove trailing comma and space
            gradientString = gradientString.slice(0, -2);

            let chartHTML = `
                <h4>${title}</h4>
                <div class="simple-pie-chart" style="background: conic-gradient(${gradientString})"></div>
                <div class="pie-legend">
            `;

            data.forEach((item, index) => {
                chartHTML += `
                    <div class="pie-legend-item">
                        <div class="pie-legend-color" style="background: ${colors[index % colors.length]}"></div>
                        <span>${item.vehicle_type}</span>
                    </div>
                `;
            });

            chartHTML += `</div>`;
            container.innerHTML = chartHTML;
        }

        // Populate the report with data
        function populateReportWithData() {
            // Update summary cards
            document.getElementById('totalVehicles').textContent = formatNumber(summaryData.total_vehicles_all_roads || 0);
            document.getElementById('totalPeople').textContent = formatNumber(summaryData.total_people_all_roads || 0);
            document.getElementById('totalDelay').textContent = formatFloat(summaryData.total_delay_hours_all_roads || 0) + ' hours';

            const totalEconomicImpact = (summaryData.total_fuel_cost_all_roads || 0) + (summaryData.total_productivity_loss_all_roads || 0);
            document.getElementById('totalEconomicImpact').textContent = formatCurrency(totalEconomicImpact);

            // Update CO2 and tree equivalent
            const totalCO2 = summaryData.total_co2_all_roads || 0;
            document.getElementById('totalCO2').textContent = formatFloat(totalCO2) + ' kg CO₂';
            document.getElementById('treeEquivalent').textContent = Math.round(totalCO2 / 20);

            // Format advanced parameters
            if (summaryData.Free_Flow_Speed_KPH !== undefined) {
                document.getElementById('freeFlowSpeed').textContent = formatFloat(summaryData.Free_Flow_Speed_KPH);
                document.getElementById('methodologyFreeFlowSpeed').textContent = formatFloat(summaryData.Free_Flow_Speed_KPH);
            }

            if (summaryData.Congested_Speed_KPH !== undefined) {
                document.getElementById('congestedSpeed').textContent = formatFloat(summaryData.Congested_Speed_KPH);
                document.getElementById('methodologyCongestedSpeed').textContent = formatFloat(summaryData.Congested_Speed_KPH);
            }

            if (summaryData.Avg_Acceleration !== undefined) {
                document.getElementById('acceleration').textContent = formatFloat(summaryData.Avg_Acceleration);
                document.getElementById('methodologyAcceleration').textContent = formatFloat(summaryData.Avg_Acceleration);
            }

            if (summaryData.Avg_Deceleration !== undefined) {
                document.getElementById('deceleration').textContent = formatFloat(summaryData.Avg_Deceleration);
            }

            if (summaryData.Idle_Time_Percentage !== undefined) {
                const idleTimePercent = summaryData.Idle_Time_Percentage * 100;
                document.getElementById('idleTime').textContent = formatFloat(idleTimePercent);
                document.getElementById('methodologyIdleTime').textContent = formatFloat(idleTimePercent);
            }

            // Populate grand totals table
            const grandTotalsBody = document.getElementById('grandTotalsBody');
            grandTotalsBody.innerHTML = `
                <tr>
                    <td>Total Vehicles Observed</td>
                    <td>${formatNumber(summaryData.total_vehicles_all_roads || 0)}</td>
                    <td>vehicles</td>
                </tr>
                <tr>
                    <td>Total People Affected</td>
                    <td>${formatNumber(summaryData.total_people_all_roads || 0)}</td>
                    <td>people</td>
                </tr>
                <tr>
                    <td>Total Delay Time</td>
                    <td>${formatFloat(summaryData.total_delay_hours_all_roads || 0)}</td>
                    <td>hours</td>
                </tr>
                <tr>
                    <td>Total Excess Fuel Consumption</td>
                    <td>${formatFloat(summaryData.total_excess_fuel_all_roads || 0)}</td>
                    <td>liters</td>
                </tr>
                <tr>
                    <td>Total Fuel Cost</td>
                    <td>${formatCurrency(summaryData.total_fuel_cost_all_roads || 0)}</td>
                    <td>naira</td>
                </tr>
                <tr>
                    <td>Total CO2 Emissions</td>
                    <td>${formatFloat(summaryData.total_co2_all_roads || 0)}</td>
                    <td>kg</td>
                </tr>
                <tr>
                    <td>Total Productivity Loss</td>
                    <td>${formatCurrency(summaryData.total_productivity_loss_all_roads || 0)}</td>
                    <td>naira</td>
                </tr>
                <tr style="background-color: #e3f2fd;">
                    <td><strong>Total Economic Impact</strong></td>
                    <td><strong>${formatCurrency(totalEconomicImpact)}</strong></td>
                    <td><strong>naira</strong></td>
                </tr>
            `;

            // Populate road comparison
            const roadComparison = document.getElementById('roadComparison');
            roadComparison.innerHTML = '';

            for (const [roadName, roadData] of Object.entries(processedRoadResultsData)) {
                const roadImpact = (roadData.total_fuel_cost_naira || 0) + (roadData.total_productivity_loss_naira || 0);

                roadComparison.innerHTML += `
                    <div class="road-card">
                        <h4>${roadName}</h4>
                        <table>
                            <tr>
                                <td>Vehicles</td>
                                <td>${formatNumber(roadData.total_vehicles || 0)}</td>
                            </tr>
                            <tr>
                                <td>People Affected</td>
                                <td>${formatNumber(roadData.total_people || 0)}</td>
                            </tr>
                            <tr>
                                <td>Excess Fuel</td>
                                <td>${formatFloat(roadData.total_excess_fuel_l || 0)} L</td>
                            </tr>
                            <tr>
                                <td>Fuel Cost</td>
                                <td>${formatCurrency(roadData.total_fuel_cost_naira || 0)}</td>
                            </tr>
                            <tr>
                                <td>CO2 Emissions</td>
                                <td>${formatFloat(roadData.total_co2_kg || 0)} kg</td>
                            </tr>
                            <tr>
                                <td>Productivity Loss</td>
                                <td>${formatCurrency(roadData.total_productivity_loss_naira || 0)}</td>
                            </tr>
                            <tr style="background-color: #e8f4fc;">
                                <td><strong>Total Impact</strong></td>
                                <td><strong>${formatCurrency(roadImpact)}</strong></td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            // Populate vehicle distribution charts section
            const vehicleDistributionCharts = document.getElementById('vehicleDistributionCharts');
            vehicleDistributionCharts.innerHTML = '';

            for (const [roadName, vehicles] of Object.entries(processedVehicleDistributionsData)) {
                if (vehicles && vehicles.length > 0) {
                    const chartId = `vehicleChart-${roadName.replace(/\s+/g, '-')}`;
                    vehicleDistributionCharts.innerHTML += `
                        <div class="chart-box" id="${chartId}">
                            <div class="chart-loading">
                                <div class="spinner"></div>
                                <p>Loading chart data...</p>
                            </div>
                        </div>
                    `;

                    // Create the chart after a short delay to allow DOM update
                    setTimeout(() => {
                        createSimplePieChart(vehicles, `${roadName} Vehicle Distribution`, chartId);
                    }, 100);
                }
            }

            // Create comparative charts
            setTimeout(() => {
                // People affected chart
                const peopleData = {};
                for (const [roadName, roadData] of Object.entries(processedRoadResultsData)) {
                    peopleData[roadName] = roadData.total_people || 0;
                }
                createSimpleBarChart(peopleData, "People Affected by Congestion", "peopleChart", formatNumber);

                // Fuel consumption chart
                const fuelData = {};
                for (const [roadName, roadData] of Object.entries(processedRoadResultsData)) {
                    fuelData[roadName] = roadData.total_excess_fuel_l || 0;
                }
                createSimpleBarChart(fuelData, "Excess Fuel Consumption (Liters)", "fuelChart", formatFloat);

                // CO2 emissions chart
                const co2Data = {};
                for (const [roadName, roadData] of Object.entries(processedRoadResultsData)) {
                    co2Data[roadName] = roadData.total_co2_kg || 0;
                }
                createSimpleBarChart(co2Data, "CO2 Emissions (kg)", "co2Chart", formatFloat);

                // Total cost chart
                const costData = {};
                for (const [roadName, roadData] of Object.entries(processedRoadResultsData)) {
                    costData[roadName] = (roadData.total_fuel_cost_naira || 0) + (roadData.total_productivity_loss_naira || 0);
                }
                createSimpleBarChart(costData, "Total Cost (Fuel + Productivity Loss)", "costChart", formatCurrency);
            }, 200);

            // Populate report data table
            const reportDataBody = document.getElementById('reportDataBody');
            reportDataBody.innerHTML = '';

            let hasData = false;

            for (const [roadName, roadData] of Object.entries(processedRoadResultsData)) {
                if (roadData.vehicle_types) {
                    for (const vehicleType of Object.keys(VEHICLE_CLASSES)) {
                        const vehicleData = roadData.vehicle_types[vehicleType] || {
                            count: 0,
                            people: 0,
                            delay_min: 0,
                            excess_fuel_l: 0,
                            fuel_cost_naira: 0,
                            co2_kg: 0,
                            productivity_loss_naira: 0
                        };
                        hasData = true;
                        reportDataBody.innerHTML += `
                            <tr>
                                <td>${roadName}</td>
                                <td>${VEHICLE_CLASSES[vehicleType]}</td>
                                <td>${formatNumber(vehicleData.count)}</td>
                                <td>${formatNumber(vehicleData.people)}</td>
                                <td>${formatFloat(vehicleData.delay_min)}</td>
                                <td>${formatFloat(vehicleData.excess_fuel_l)}</td>
                                <td>${formatCurrency(vehicleData.fuel_cost_naira)}</td>
                                <td>${formatFloat(vehicleData.co2_kg)}</td>
                                <td>${formatCurrency(vehicleData.productivity_loss_naira)}</td>
                                <td>${emissionModel}</td>
                            </tr>
                        `;
                    }
                }
            }

            if (!hasData) {
                reportDataBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="no-data">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>No detailed data available. Please check your data input.</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Initialize the report when page loads
        document.addEventListener('DOMContentLoaded', function() {
            populateReportWithData();
        });
    </script>
</body>
</html>