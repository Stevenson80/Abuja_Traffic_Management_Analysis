<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abuja Traffic Analysis Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
            @bottom-right {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10pt;
                color: #666;
            }
            @bottom-left {
                content: "Â© {{ current_year }} | Powered by Opygoal Technology Ltd | Developed by Oladotun Ajakaiye";
                font-size: 8pt;
                color: #666;
            }
        }
        :root {
            --primary-color: #1a2a6c;
            --secondary-color: #b21f1f;
            --accent-color: #fdbb2d;
            --light-color: #f0f7ff;
            --dark-color: #2c3e50;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 15px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-family: 'Poppins', sans-serif;
        }
        .btn:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057, #6c757d);
        }
        .cover-page {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            page-break-after: always;
        }
        .cover-page h1 {
            font-size: 2.8em;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--primary-color);
        }
        .cover-page h2 {
            font-size: 1.4em;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--dark-color);
        }
        .cover-page h3 {
            font-size: 1.2em;
            margin: 20px 0 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--primary-color);
        }
        .cover-page p {
            font-size: 1em;
            max-width: 800px;
            margin: 10px auto;
            color: var(--text-color);
        }
        .cover-page .nav-links {
            margin: 20px 0;
            font-size: 1.1em;
        }
        .cover-page .nav-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }
        .cover-page .nav-links a:hover {
            text-decoration: underline;
        }
        .cover-page .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .cover-page .stats div {
            background: var(--light-color);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 180px;
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--box-shadow);
        }
        .cover-page .stats h3 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
        }
        .cover-page .stats p {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: var(--dark-color);
        }
        .cover-page .section {
            text-align: left;
            margin: 20px 40px;
        }
        .cover-page .section h2 {
            font-size: 1.4em;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .cover-page .section .feature-item {
            margin-bottom: 15px;
        }
        .cover-page .section ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .cover-page .section li {
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            page-break-inside: avoid;
        }
        h1, h2, h3, h4 {
            color: var(--primary-color);
            font-family: 'Poppins', sans-serif;
            margin-bottom: 20px;
        }
        h2 {
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .summary-card {
            background: var(--light-color);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--dark-color);
        }
        .summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .summary-card .subtext {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.95em;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin: 35px 0;
            page-break-inside: avoid;
        }
        .chart-box {
            flex: 1 1 400px;
            min-width: 300px;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
            text-align: center;
        }
        .chart-box h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: var(--dark-color);
        }
        .chart-box img {
            max-width: 100%;
            height: auto;
        }
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            font-size: 0.95em;
            color: #666;
            border-top: 1px solid #eaeaea;
        }
        .no-print {
            display: block;
        }
        .road-comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
        }
        .road-card {
            flex: 1;
            min-width: 300px;
            background: var(--light-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .road-card h3 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .key-findings {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: var(--border-radius);
        }
        .recommendations {
            background: #d1ecf1;
            border-left: 4px solid #0dcaf0;
            padding: 20px;
            margin: 20px 0;
            border-radius: var(--border-radius);
        }
        .model-info {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            margin: 15px 0;
        }
        .model-info h3 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }
        .model-info p {
            margin: 0;
            font-size: 12px;
        }
        .model-info .model-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
            margin-right: 8px;
        }
        ul, ol {
            padding-left: 30px;
            margin: 15px 0;
        }
        li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .chart-img-container {
            text-align: center;
            margin: 15px 0;
            display: none;
        }
        .chart-img-container img {
            max-width: 100%;
            height: auto;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                padding: 0;
                background-color: white;
                font-size: 12pt;
            }
            .section, .cover-page {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            .summary-card, .road-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            .chart-box {
                page-break-inside: avoid;
            }
            table {
                page-break-inside: avoid;
            }
            canvas {
                display: none !important;
            }
            .chart-img-container {
                display: block !important;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .cover-page {
                padding: 30px 15px;
            }
            .cover-page h1 {
                font-size: 2.2em;
            }
            .controls {
                flex-direction: column;
                align-items: flex-end;
            }
            .btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }
            .chart-container {
                gap: 20px;
            }
            .chart-box {
                flex: 1 1 100%;
            }
            .cover-page .stats {
                flex-direction: column;
                align-items: center;
            }
            .cover-page .stats div {
                width: 100%;
                max-width: 300px;
            }
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-source-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.9em;
            border-left: 4px solid #6c757d;
        }
        .data-source-info strong {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Generating PDF report...</p>
    </div>

    <div class="controls no-print">
        <button class="btn" onclick="downloadPDF()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            Download PDF Report
        </button>
        <button class="btn btn-secondary" onclick="window.print()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/>
                <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
            </svg>
            Print Report
        </button>
    </div>

    <div id="report-content">
        <!-- Cover Page -->
        <div class="cover-page">
            <h1>Abuja Traffic Analysis System</h1>
            <h2>Comprehensive traffic congestion analysis for major Abuja roads to support data-driven transportation planning</h2>
            <p>Generated on: <span id="currentDateDisplay"></span> at <span id="currentTimeDisplay"></span></p>
            <p>Emission Model: <span id="emissionModelDisplay"></span></p>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/analysis">Analysis</a>
                <a href="/data_entry">Data Entry</a>
                <a href="/download_csv">Download CSV</a>
                <a href="/download_pdf">Download PDF</a>
            </div>
            <h3>Welcome to the Abuja Traffic Analysis System</h3>
            <p>This advanced system provides comprehensive analysis of traffic congestion on major Abuja roads, helping transportation planners, policymakers, and urban developers make data-driven decisions to improve traffic flow, reduce congestion, and minimize environmental impact.</p>
            <div class="stats">
                <div>
                    <h3 id="roadsCount">3</h3>
                    <p>Major Roads Analyzed</p>
                </div>
                <div>
                    <h3>10</h3>
                    <p>Vehicle Types Tracked</p>
                </div>
                <div>
                    <h3>8</h3>
                    <p>Key Performance Metrics</p>
                </div>
            </div>
            <div class="section">
                <h2>System Features</h2>
                <div class="feature-item">
                    <h3>Data Entry</h3>
                    <p>Easily input traffic data for different vehicle types across Abuja's major roads with our intuitive form interface.</p>
                </div>
                <div class="feature-item">
                    <h3>Comprehensive Analysis</h3>
                    <p>Get detailed analysis of traffic congestion, including fuel costs, CO2 emissions, productivity losses, and economic impact.</p>
                </div>
                <div class="feature-item">
                    <h3>Report Generation</h3>
                    <p>Download detailed reports in CSV and PDF formats for further analysis, presentations, and official documentation.</p>
                </div>
            </div>
            <div class="section">
                <h2>How It Works</h2>
                <ul>
                    <li><strong>Data Collection:</strong> Navigate to the Data Entry page to input traffic data for different vehicle types.</li>
                    <li><strong>Analysis:</strong> View comprehensive analysis on the Analysis page with visual charts and detailed metrics.</li>
                    <li><strong>Reporting:</strong> Download reports in CSV or PDF format for your records and presentations.</li>
                    <li><strong>Decision Making:</strong> Use the insights to make data-driven transportation and urban planning decisions.</li>
                </ul>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="section">
            <h2>Executive Summary</h2>
            <p>This report presents a comprehensive analysis of traffic congestion across major Abuja roads. The analysis quantifies the economic and environmental impact of congestion through multiple metrics including delay times, fuel consumption, CO2 emissions, and productivity loss.</p>
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Vehicles</h3>
                    <div class="value" id="totalVehicles">0</div>
                    <div class="subtext">across all roads</div>
                </div>
                <div class="summary-card">
                    <h3>People Affected</h3>
                    <div class="value" id="totalPeople">0</div>
                    <div class="subtext">commuters impacted</div>
                </div>
                <div class="summary-card">
                    <h3>Total Delay</h3>
                    <div class="value" id="totalDelay">0 hours</div>
                    <div class="subtext">due to congestion</div>
                </div>
                <div class="summary-card">
                    <h3>Economic Impact</h3>
                    <div class="value" id="totalEconomicImpact">â¦0</div>
                    <div class="subtext">fuel cost + productivity loss</div>
                </div>
            </div>
            <p id="executiveInsight">The analysis reveals significant congestion across all corridors, highlighting the urgent need for targeted interventions to alleviate traffic congestion and its associated economic and environmental costs.</p>
        </div>

        <!-- Data Source Information -->
        <div class="section">
            <h2>Data Source Information</h2>
            <div class="data-source-info">
                <p><strong>Data Source:</strong> <span id="dataSourceInfo">Hardcoded sample data</span></p>
                <p><strong>Analysis Date:</strong> <span id="analysisDateInfo"></span></p>
                <p><strong>Analysis Time:</strong> <span id="analysisTimeInfo"></span></p>
                <p><strong>Corridor Length:</strong> 6.0 km (standardized for all roads)</p>
                <p><strong>Time Period:</strong> Evening rush hour (18:00)</p>
            </div>
        </div>

        <!-- Emission Model Information -->
        <div class="section">
            <h2>Analysis Methodology</h2>
            <div class="model-info">
                <h3>Emission Calculation Model</h3>
                <p>
                    <span class="model-badge" id="emissionModelBadge">BASIC</span>
                    <span id="modelDescription">Using simple fuel consumption-based emission calculations with fixed emission factors.</span>
                </p>
            </div>
            <p>This analysis uses vehicle-specific occupancy rates and fuel consumption parameters. Key assumptions include:</p>
            <ul id="methodologyAssumptions">
                <li><strong>Fuel prices:</strong> â¦1,045/L for petrol and â¦1,210/L for diesel (2026 prices)</li>
                <li><strong>CO2 emission factors:</strong> 2.31 kg CO2/L for petrol and 2.68 kg CO2/L for diesel</li>
                <li><strong>Productivity Loss</strong> calculated using a value of time of â¦8.80/minute</li>
                <li><strong>Distance:</strong> 6.0 km average corridor length</li>
                <li><strong>Free Flow Time:</strong> 4.0 minutes, <strong>Congested Time:</strong> 45.0 minutes</li>
                <li><strong>Free Flow Speed:</strong> 60.0 km/h, <strong>Congested Speed:</strong> 8.0 km/h</li>
                <li><strong>Acceleration/Deceleration:</strong> 0.5 m/sÂ², <strong>Idle Time:</strong> 30%</li>
                <li>Data represents current traffic conditions during evening rush hour</li>
            </ul>
        </div>

        <!-- Grand Totals -->
        <div class="section">
            <h2>Grand Totals Across All Roads</h2>
            <table>
                <thead>
                    <tr>
                        <th>Performance Metric</th>
                        <th>Value</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody id="grandTotalsBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Per-Road Analysis -->
        <div class="section">
            <h2>Per-Road Analysis</h2>
            <div class="road-comparison" id="roadComparison">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Vehicle Distribution Charts -->
        <div class="section">
            <h2>Vehicle Distribution Analysis</h2>
            <p>The following pie charts illustrate the distribution of vehicle types across each road corridor:</p>
            <div class="chart-container" id="vehicleDistributionCharts">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Comparative Analysis -->
        <div class="section">
            <h2>Comparative Analysis Across Roads</h2>
            <p>The following bar charts compare key metrics across the road corridors:</p>
            <div class="chart-container">
                <div class="chart-box">
                    <h3>People Affected by Congestion</h3>
                    <canvas id="peopleChart"></canvas>
                    <div class="chart-img-container" id="peopleChartImg"></div>
                </div>
                <div class="chart-box">
                    <h3>Fuel Cost Comparison (â¦)</h3>
                    <canvas id="fuelCostChart"></canvas>
                    <div class="chart-img-container" id="fuelCostChartImg"></div>
                </div>
                <div class="chart-box">
                    <h3>Productivity Loss (â¦)</h3>
                    <canvas id="productivityChart"></canvas>
                    <div class="chart-img-container" id="productivityChartImg"></div>
                </div>
                <div class="chart-box">
                    <h3>CO2 Emissions (kg)</h3>
                    <canvas id="co2Chart"></canvas>
                    <div class="chart-img-container" id="co2ChartImg"></div>
                </div>
            </div>
        </div>

        <!-- Detailed Data Table -->
        <div class="section">
            <h2>Detailed Analysis Data</h2>
            <table id="detailedDataTable">
                <thead>
                    <tr>
                        <th>Road</th>
                        <th>Vehicle Count</th>
                        <th>People Affected</th>
                        <th>Excess Fuel (L)</th>
                        <th>CO2 Emissions (kg)</th>
                        <th>Fuel Cost (â¦)</th>
                        <th>Productivity Loss (â¦)</th>
                        <th>Total Impact (â¦)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Conclusions -->
        <div class="section">
            <h2>Conclusions and Recommendations</h2>
            <div class="key-findings">
                <h3>Key Findings</h3>
                <ul id="keyFindings">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>
            <div class="recommendations">
                <h3>Strategic Recommendations</h3>
                <ul id="strategicRecommendations">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>
        </div>

        <div class="footer">
            <p>Â© <span id="currentYear"></span> | Powered by Opygoal Technology Ltd | Developed by Oladotun Ajakaiye | Service Manager & Data Analyst</p>
        </div>
    </div>

    <script>
        // Set current date and year
        const currentDate = new Date();
        document.getElementById('currentYear').textContent = currentDate.getFullYear();
        document.getElementById('currentDateDisplay').textContent = currentDate.toLocaleDateString();
        document.getElementById('currentTimeDisplay').textContent = currentDate.toLocaleTimeString();
        document.getElementById('analysisDateInfo').textContent = currentDate.toLocaleDateString();
        document.getElementById('analysisTimeInfo').textContent = currentDate.toLocaleTimeString();

        // Store chart instances for later use
        const charts = {};
        let analysisData = {};

        // Fetch analysis data from the server
        async function fetchAnalysisData() {
            try {
                showLoading();
                const urlParams = new URLSearchParams(window.location.search);
                const emissionModelParam = urlParams.get('emission_model') || 'basic';
                const response = await fetch(`/api/analysis?emission_model=${emissionModelParam}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // Process the data to match expected format
                analysisData = {
                    summary: data.total_summary || {},
                    roadResults: data.road_results || {},
                    vehicleDistributions: data.vehicle_distributions || {},
                    emissionModel: emissionModelParam,
                    dataSource: data.data_source || 'API'
                };

                document.getElementById('dataSourceInfo').textContent = analysisData.dataSource;
                document.getElementById('emissionModelDisplay').textContent = analysisData.emissionModel.toUpperCase();

                populateReportWithData();
                initializeCharts();
                hideLoading();
            } catch (error) {
                console.error('Error fetching analysis data:', error);
                alert('Failed to load analysis data from API. Loading sample data.');
                loadSampleData();
            }
        }

        // Load sample data for demonstration
        function loadSampleData() {
            analysisData = {
                summary: {
                    total_vehicles_all_roads: 760,
                    total_people_all_roads: 3521,
                    total_delay_hours_all_roads: 512.7,
                    total_excess_fuel_all_roads: 245.3,
                    total_fuel_cost_all_roads: 256420,
                    total_co2_all_roads: 598.2,
                    total_productivity_loss_all_roads: 985630
                },
                roadResults: {
                    'Nyanya Road': {
                        total_vehicles: 280,
                        total_people: 1325,
                        total_excess_fuel_l: 92.4,
                        total_fuel_cost_naira: 96580,
                        total_co2_kg: 223.7,
                        total_productivity_loss_naira: 389450
                    },
                    'Lugbe Road': {
                        total_vehicles: 250,
                        total_people: 1150,
                        total_excess_fuel_l: 78.6,
                        total_fuel_cost_naira: 82170,
                        total_co2_kg: 190.3,
                        total_productivity_loss_naira: 312480
                    },
                    'Kubwa Road': {
                        total_vehicles: 230,
                        total_people: 1046,
                        total_excess_fuel_l: 74.3,
                        total_fuel_cost_naira: 77670,
                        total_co2_kg: 184.2,
                        total_productivity_loss_naira: 283700
                    }
                },
                vehicleDistributions: {
                    'Nyanya Road': [
                        { vehicle_type: 'Cars', count: 85 },
                        { vehicle_type: 'Motorcycles', count: 65 },
                        { vehicle_type: 'SUVs', count: 45 },
                        { vehicle_type: 'Sedans', count: 35 },
                        { vehicle_type: 'Wagons', count: 20 },
                        { vehicle_type: 'Short Buses', count: 15 },
                        { vehicle_type: 'Minibusses', count: 8 },
                        { vehicle_type: 'Long Buses', count: 5 },
                        { vehicle_type: 'Truck', count: 2 }
                    ],
                    'Lugbe Road': [
                        { vehicle_type: 'Cars', count: 90 },
                        { vehicle_type: 'Motorcycles', count: 60 },
                        { vehicle_type: 'SUVs', count: 40 },
                        { vehicle_type: 'Sedans', count: 30 },
                        { vehicle_type: 'Wagons', count: 15 },
                        { vehicle_type: 'Short Buses', count: 8 },
                        { vehicle_type: 'Minibusses', count: 5 },
                        { vehicle_type: 'Long Buses', count: 2 }
                    ],
                    'Kubwa Road': [
                        { vehicle_type: 'Cars', count: 80 },
                        { vehicle_type: 'Motorcycles', count: 55 },
                        { vehicle_type: 'SUVs', count: 35 },
                        { vehicle_type: 'Sedans', count: 25 },
                        { vehicle_type: 'Wagons', count: 18 },
                        { vehicle_type: 'Short Buses', count: 10 },
                        { vehicle_type: 'Minibusses', count: 5 },
                        { vehicle_type: 'Long Buses', count: 2 }
                    ]
                },
                emissionModel: 'basic',
                dataSource: 'Sample Data'
            };

            document.getElementById('dataSourceInfo').textContent = analysisData.dataSource;
            document.getElementById('emissionModelDisplay').textContent = analysisData.emissionModel.toUpperCase();

            populateReportWithData();
            initializeCharts();
        }

        // Populate the report with data
        function populateReportWithData() {
            const { summary, roadResults, emissionModel } = analysisData;

            // Update roads count
            document.getElementById('roadsCount').textContent = Object.keys(roadResults).length;

            // Update summary cards
            document.getElementById('totalVehicles').textContent = formatNumber(summary.total_vehicles_all_roads);
            document.getElementById('totalPeople').textContent = formatNumber(summary.total_people_all_roads);
            document.getElementById('totalDelay').textContent = `${formatNumber(summary.total_delay_hours_all_roads, 1)} hours`;
            const totalEconomicImpact = summary.total_fuel_cost_all_roads + summary.total_productivity_loss_all_roads;
            document.getElementById('totalEconomicImpact').textContent = `â¦${formatNumber(totalEconomicImpact)}`;

            // Update emission model info
            document.getElementById('emissionModelBadge').textContent = emissionModel.toUpperCase();
            const modelDescriptions = {
                'basic': 'Using simple fuel consumption-based emission calculations with fixed emission factors.',
                'barth': 'Using Barth\'s comprehensive fuel consumption model with acceleration, deceleration, and idle time factors.',
                'moves': 'Using EPA MOVES-like emission model with speed, acceleration, and vehicle standard corrections.'
            };
            document.getElementById('modelDescription').textContent = modelDescriptions[emissionModel] || 'Using custom emission calculation model.';

            // Update executive insight
            const highestImpactRoad = Object.entries(roadResults).reduce((max, [road, data]) => {
                const impact = data.total_fuel_cost_naira + data.total_productivity_loss_naira;
                return impact > max.impact ? { road, impact, data } : max;
            }, { road: '', impact: 0, data: null });

            const impactPercentage = ((highestImpactRoad.impact / totalEconomicImpact) * 100).toFixed(1);
            const insightText = `The analysis reveals significant congestion across all corridors, with ${highestImpactRoad.road} experiencing the highest impact (â¦${formatNumber(highestImpactRoad.impact)}, ${impactPercentage}% of total). The findings highlight the urgent need for targeted interventions to alleviate traffic congestion and its associated economic and environmental costs.`;
            document.getElementById('executiveInsight').textContent = insightText;

            // Populate grand totals table
            const grandTotalsBody = document.getElementById('grandTotalsBody');
            grandTotalsBody.innerHTML = `
                <tr>
                    <td>Total Vehicles Observed</td>
                    <td>${formatNumber(summary.total_vehicles_all_roads)}</td>
                    <td>vehicles</td>
                </tr>
                <tr>
                    <td>Total People Affected</td>
                    <td>${formatNumber(summary.total_people_all_roads)}</td>
                    <td>people</td>
                </tr>
                <tr>
                    <td>Total Delay Time</td>
                    <td>${formatNumber(summary.total_delay_hours_all_roads, 1)}</td>
                    <td>hours</td>
                </tr>
                <tr>
                    <td>Total Excess Fuel Consumption</td>
                    <td>${formatNumber(summary.total_excess_fuel_all_roads, 1)}</td>
                    <td>liters</td>
                </tr>
                <tr>
                    <td>Total Fuel Cost</td>
                    <td>â¦${formatNumber(summary.total_fuel_cost_all_roads)}</td>
                    <td>naira</td>
                </tr>
                <tr>
                    <td>Total CO2 Emissions</td>
                    <td>${formatNumber(summary.total_co2_all_roads, 1)}</td>
                    <td>kg</td>
                </tr>
                <tr>
                    <td>Total Productivity Loss</td>
                    <td>â¦${formatNumber(summary.total_productivity_loss_all_roads)}</td>
                    <td>naira</td>
                </tr>
                <tr>
                    <td><strong>Total Economic Impact</strong></td>
                    <td><strong>â¦${formatNumber(totalEconomicImpact)}</strong></td>
                    <td><strong>naira</strong></td>
                </tr>
            `;

            // Populate road comparison
            const roadComparison = document.getElementById('roadComparison');
            roadComparison.innerHTML = '';
            for (const [roadName, roadData] of Object.entries(roadResults)) {
                const roadImpact = roadData.total_fuel_cost_naira + roadData.total_productivity_loss_naira;
                roadComparison.innerHTML += `
                    <div class="road-card">
                        <h3>${roadName}</h3>
                        <table>
                            <tr>
                                <td>Vehicles</td>
                                <td>${formatNumber(roadData.total_vehicles)}</td>
                            </tr>
                            <tr>
                                <td>People Affected</td>
                                <td>${formatNumber(roadData.total_people)}</td>
                            </tr>
                            <tr>
                                <td>Excess Fuel</td>
                                <td>${formatNumber(roadData.total_excess_fuel_l, 1)} L</td>
                            </tr>
                            <tr>
                                <td>Fuel Cost</td>
                                <td>â¦${formatNumber(roadData.total_fuel_cost_naira)}</td>
                            </tr>
                            <tr>
                                <td>CO2 Emissions</td>
                                <td>${formatNumber(roadData.total_co2_kg, 1)} kg</td>
                            </tr>
                            <tr>
                                <td>Productivity Loss</td>
                                <td>â¦${formatNumber(roadData.total_productivity_loss_naira)}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Impact</strong></td>
                                <td><strong>â¦${formatNumber(roadImpact)}</strong></td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            // Populate detailed data table
            const detailedTableBody = document.querySelector('#detailedDataTable tbody');
            detailedTableBody.innerHTML = '';
            for (const [roadName, roadData] of Object.entries(roadResults)) {
                const roadImpact = roadData.total_fuel_cost_naira + roadData.total_productivity_loss_naira;
                detailedTableBody.innerHTML += `
                    <tr>
                        <td>${roadName}</td>
                        <td>${formatNumber(roadData.total_vehicles)}</td>
                        <td>${formatNumber(roadData.total_people)}</td>
                        <td>${formatNumber(roadData.total_excess_fuel_l, 1)}</td>
                        <td>${formatNumber(roadData.total_co2_kg, 1)}</td>
                        <td>â¦${formatNumber(roadData.total_fuel_cost_naira)}</td>
                        <td>â¦${formatNumber(roadData.total_productivity_loss_naira)}</td>
                        <td>â¦${formatNumber(roadImpact)}</td>
                    </tr>
                `;
            }

            // Populate key findings
            const keyFindings = document.getElementById('keyFindings');
            const avgDelayPerVehicle = (summary.total_delay_hours_all_roads * 60 / summary.total_vehicles_all_roads).toFixed(1);
            const highestRoad = Object.entries(roadResults).reduce((a, b) =>
                a[1].total_vehicles > b[1].total_vehicles ? a : b);
            const highestRoadPercentage = ((highestRoad[1].total_vehicles / summary.total_vehicles_all_roads) * 100).toFixed(1);

            keyFindings.innerHTML = `
                <li>${highestRoad[0]} shows the highest congestion impact, accounting for approximately ${highestRoadPercentage}% of total vehicles</li>
                <li>Traffic congestion affects ${formatNumber(summary.total_people_all_roads)} commuters during the observed period</li>
                <li>The economic impact is substantial, with over â¦${formatNumber(totalEconomicImpact)} in combined fuel costs and productivity loss</li>
                <li>Environmental impacts include ${formatNumber(summary.total_co2_all_roads, 1)} kg of excess CO2 emissions</li>
                <li>The average delay per vehicle is ${avgDelayPerVehicle} minutes across all roads</li>
                <li>Analysis performed using <strong>${emissionModel.toUpperCase()}</strong> emission model for enhanced accuracy</li>
            `;

            // Populate recommendations
            const recommendations = document.getElementById('strategicRecommendations');
            recommendations.innerHTML = `
                <li><strong>Immediate Interventions:</strong> Implement targeted traffic management systems on ${highestRoad[0]}, which shows the highest congestion metrics</li>
                <li><strong>Public Transportation:</strong> Enhance alternative transportation options to reduce private vehicle numbers during peak hours</li>
                <li><strong>Infrastructure Investment:</strong> Prioritize road improvements based on specific vehicle type distributions observed</li>
                <li><strong>Policy Measures:</strong> Consider congestion pricing or staggered work hours to distribute traffic more evenly</li>
                <li><strong>Data Collection:</strong> Expand monitoring to understand daily and weekly patterns beyond current snapshot data</li>
                <li><strong>Environmental Mitigation:</strong> Implement measures to offset ${formatNumber(summary.total_co2_all_roads, 1)} kg of CO2 emissions generated</li>
                <li><strong>Model Selection:</strong> Continue using ${emissionModel.toUpperCase()} model for future analyses to maintain consistency in emission calculations</li>
            `;
        }

        // Format numbers with commas
        function formatNumber(value, decimals = 0) {
            if (typeof value !== 'number' || isNaN(value)) return '0';
            return value.toLocaleString(undefined, {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Initialize charts with data
        function initializeCharts() {
            const { roadResults, vehicleDistributions } = analysisData;
            const roadNames = Object.keys(roadResults);

            // Create vehicle distribution charts
            const vehicleDistributionCharts = document.getElementById('vehicleDistributionCharts');
            vehicleDistributionCharts.innerHTML = '';
            for (const roadName of roadNames) {
                const vehicles = vehicleDistributions[roadName];
                if (vehicles && vehicles.length > 0) {
                    vehicleDistributionCharts.innerHTML += `
                        <div class="chart-box">
                            <h3>${roadName} Vehicle Distribution</h3>
                            <canvas id="pie-${roadName.replace(' ', '-').toLowerCase()}"></canvas>
                            <div class="chart-img-container" id="pie-${roadName.replace(' ', '-').toLowerCase()}-img"></div>
                        </div>
                    `;
                }
            }

            // Initialize charts after DOM update
            setTimeout(() => {
                // Generate pie charts for each road
                for (const roadName of roadNames) {
                    const vehicles = vehicleDistributions[roadName];
                    if (vehicles && vehicles.length > 0) {
                        const canvasId = `pie-${roadName.replace(' ', '-').toLowerCase()}`;
                        const ctx = document.getElementById(canvasId);
                        if (ctx) {
                            const labels = vehicles.map(v => v.vehicle_type);
                            const data = vehicles.map(v => v.count);
                            const backgroundColors = [
                                '#1a2a6c', '#b21f1f', '#fdbb2d', '#1c6b3d', '#6b2c90',
                                '#2a6b55', '#6b2c4d', '#4d2c6b', '#6b4d2c', '#2c6b6b'
                            ];

                            charts[canvasId] = new Chart(ctx, {
                                type: 'pie',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        data: data,
                                        backgroundColor: backgroundColors.slice(0, data.length)
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                boxWidth: 12,
                                                font: { size: 10 }
                                            }
                                        },
                                        title: { display: false }
                                    }
                                }
                            });
                        }
                    }
                }

                // Bar charts for comparative analysis
                const barChartData = {
                    'People Affected': roadNames.map(road => roadResults[road].total_people),
                    'Fuel Cost': roadNames.map(road => roadResults[road].total_fuel_cost_naira),
                    'Productivity Loss': roadNames.map(road => roadResults[road].total_productivity_loss_naira),
                    'CO2 Emissions': roadNames.map(road => roadResults[road].total_co2_kg)
                };
                const barChartIds = ['peopleChart', 'fuelCostChart', 'productivityChart', 'co2Chart'];
                const barChartMetrics = Object.keys(barChartData);
                const barColors = ['#1a2a6c', '#b21f1f', '#fdbb2d'];

                for (let i = 0; i < barChartMetrics.length; i++) {
                    const metric = barChartMetrics[i];
                    const ctx = document.getElementById(barChartIds[i]);
                    if (ctx) {
                        charts[barChartIds[i]] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: roadNames,
                                datasets: [{
                                    label: metric,
                                    data: barChartData[metric],
                                    backgroundColor: barColors
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                if (metric === 'Fuel Cost' || metric === 'Productivity Loss') {
                                                    return 'â¦' + value.toLocaleString();
                                                } else if (metric === 'CO2 Emissions') {
                                                    return value.toLocaleString() + ' kg';
                                                }
                                                return value.toLocaleString();
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    }
                }
            }, 100);
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'flex';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Convert charts to images for PDF
        async function convertChartsToImages() {
            const chartCanvases = document.querySelectorAll('canvas');
            const imagePromises = [];

            chartCanvases.forEach(canvas => {
                const promise = new Promise((resolve) => {
                    const containerId = `${canvas.id}-img`;
                    const container = document.getElementById(containerId);
                    if (container) {
                        const image = new Image();
                        image.src = canvas.toDataURL('image/png', 0.9);
                        image.alt = `Chart: ${canvas.id}`;
                        image.style.maxWidth = '100%';
                        image.style.height = 'auto';
                        container.appendChild(image);
                        canvas.style.display = 'none';
                        resolve();
                    } else {
                        resolve();
                    }
                });
                imagePromises.push(promise);
            });

            await Promise.all(imagePromises);
        }

        // Restore charts after PDF generation
        function restoreCharts() {
            document.querySelectorAll('.chart-img-container').forEach(container => {
                container.innerHTML = '';
                container.style.display = 'none';
            });
            document.querySelectorAll('canvas').forEach(canvas => {
                canvas.style.display = 'block';
            });
        }

        // Download PDF function
        async function downloadPDF() {
            showLoading();
            try {
                await convertChartsToImages();
                await new Promise(resolve => setTimeout(resolve, 500));

                const element = document.getElementById('report-content');
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `abuja_traffic_analysis_report_${new Date().toISOString().slice(0, 10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#FFFFFF',
                        letterRendering: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait',
                        compress: true
                    },
                    pagebreak: {
                        mode: ['avoid-all', 'css', 'legacy'],
                        avoid: ['.chart-box', '.summary-card', '.road-card']
                    }
                };

                await html2pdf().set(opt).from(element).save();
            } catch (err) {
                console.error('PDF generation error:', err);
                alert('Error generating PDF. Please try again.');
            } finally {
                restoreCharts();
                hideLoading();
            }
        }

        // Initialize the report when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchAnalysisData();
        });
    </script>
</body>
</html>